stages:
  - build
  - deploy

variables:
  NODE_VERSION: "20.19.0"

# Cache node_modules for faster builds
cache:
  paths:
    - frontend/node_modules/
    - backend/node_modules/

# Build frontend
build_frontend:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  only:
    - main
    - master
    - branches

# Build backend (test build)
build_backend:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - cd backend
    - npm ci
  script:
    - echo "Backend build check passed"
  only:
    - main
    - master
    - branches

# Deploy to Render (using Render API)
# Note: You'll need to set RENDER_API_KEY and RENDER_SERVICE_ID as CI/CD variables in GitLab
deploy_backend:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - |
      if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_BACKEND_SERVICE_ID" ]; then
        echo "Warning: RENDER_API_KEY or RENDER_BACKEND_SERVICE_ID not set. Skipping deployment."
        echo "Set these as CI/CD variables in GitLab Settings > CI/CD > Variables"
        exit 0
      fi
      echo "Triggering Render deployment for backend..."
      curl -X POST "https://api.render.com/v1/services/${RENDER_BACKEND_SERVICE_ID}/deploys" \
        -H "Authorization: Bearer ${RENDER_API_KEY}" \
        -H "Accept: application/json"
  only:
    - main
    - master

deploy_frontend:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - |
      if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_FRONTEND_SERVICE_ID" ]; then
        echo "Warning: RENDER_API_KEY or RENDER_FRONTEND_SERVICE_ID not set. Skipping deployment."
        echo "Set these as CI/CD variables in GitLab Settings > CI/CD > Variables"
        exit 0
      fi
      echo "Triggering Render deployment for frontend..."
      curl -X POST "https://api.render.com/v1/services/${RENDER_FRONTEND_SERVICE_ID}/deploys" \
        -H "Authorization: Bearer ${RENDER_API_KEY}" \
        -H "Accept: application/json"
  only:
    - main
    - master

